<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Import from Goodreads - BookmarkD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="bg-gray-900 text-gray-100">
<nav class="glass-nav fixed w-full z-50 top-0">
    <div class="container mx-auto px-6 py-4 flex justify-between items-center">
        <a href="feed.html" class="text-2xl font-bold gradient-text">BookmarkD</a>
        <div class="space-x-4">
            <a href="books.html" class="hover:text-blue-400 transition">Browse</a>
            <a href="feed.html" class="hover:text-blue-400 transition">Feed</a>
            <a href="profile.html" class="hover:text-blue-400 transition">Profile</a>
            <a href="stats.html" class="hover:text-blue-400 transition">Stats</a>
        </div>
    </div>
</nav>

<main class="pt-32 min-h-screen px-6">
    <div class="container mx-auto max-w-3xl">
        <div class="auth-card">
            <h1 class="text-3xl font-bold mb-2 gradient-text">Import from Goodreads</h1>
            <p class="text-gray-400 mb-8">Bring your reading history to BookmarkD</p>

            <!-- Instructions -->
            <div class="mb-8 p-4 bg-blue-500/10 border border-blue-500/50 rounded-lg">
                <h3 class="font-bold mb-2 text-blue-400">How to export from Goodreads:</h3>
                <ol class="text-sm text-gray-300 space-y-1 list-decimal list-inside">
                    <li>Go to <a href="https://www.goodreads.com/review/import" target="_blank" class="text-blue-400 hover:underline">Goodreads Export</a></li>
                    <li>Click "Export Library"</li>
                    <li>Download the CSV file</li>
                    <li>Upload it below</li>
                </ol>
            </div>

            <!-- Upload Form -->
            <form id="importForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium mb-2">Select CSV File</label>
                    <input type="file" 
                           id="csvFile" 
                           accept=".csv"
                           class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg cursor-pointer
                                  file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0
                                  file:bg-blue-600 file:text-white file:cursor-pointer
                                  hover:file:bg-blue-700">
                </div>

                <div id="errorMessage" class="hidden p-3 bg-red-500/10 border border-red-500 rounded-lg text-red-400 text-sm"></div>
                
                <div id="progressSection" class="hidden">
                    <div class="mb-2 flex justify-between text-sm">
                        <span>Importing...</span>
                        <span id="progressText">0%</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-2">
                        <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>

                <button type="submit" 
                        id="submitBtn"
                        class="btn-primary w-full">
                    Import Books
                </button>
            </form>

            <!-- Results -->
            <div id="resultsSection" class="hidden mt-8 p-4 bg-green-500/10 border border-green-500/50 rounded-lg">
                <h3 class="font-bold mb-2 text-green-400">Import Complete!</h3>
                <div class="text-sm text-gray-300 space-y-1">
                    <p><span class="font-semibold">Books imported:</span> <span id="booksImported">0</span></p>
                    <p><span class="font-semibold">Ratings created:</span> <span id="ratingsImported">0</span></p>
                    <p><span class="font-semibold">Skipped:</span> <span id="skipped">0</span></p>
                </div>
                <div id="errorsList" class="mt-4 hidden">
                    <p class="font-semibold text-yellow-400 mb-2">Errors:</p>
                    <ul class="text-xs text-gray-400 space-y-1 list-disc list-inside"></ul>
                </div>
                <a href="profile.html" class="btn-primary mt-4 inline-block">View Your Books</a>
            </div>
        </div>
    </div>
</main>

<script type="module">
    import { api, isLoggedIn } from './js/api.js';

    if (!isLoggedIn()) {
        window.location.href = 'login.html';
    }

    const form = document.getElementById('importForm');
    const fileInput = document.getElementById('csvFile');
    const submitBtn = document.getElementById('submitBtn');
    const errorMessage = document.getElementById('errorMessage');
    const progressSection = document.getElementById('progressSection');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const resultsSection = document.getElementById('resultsSection');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const file = fileInput.files[0];
        if (!file) {
            showError('Please select a CSV file');
            return;
        }

        if (!file.name.endsWith('.csv')) {
            showError('Please upload a CSV file');
            return;
        }

        errorMessage.classList.add('hidden');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Importing...';
        progressSection.classList.remove('hidden');
        resultsSection.classList.add('hidden');

        // Simulate progress
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += 5;
            if (progress <= 90) {
                updateProgress(progress);
            }
        }, 200);

        try {
            const formData = new FormData();
            formData.append('csv', file);

            const token = localStorage.getItem('token');
            const response = await fetch('http://localhost:8080/api/import/goodreads', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                body: formData
            });

            clearInterval(progressInterval);
            updateProgress(100);

            if (!response.ok) {
                const error = await response.text();
                throw new Error(error);
            }

            const result = await response.json();

            // Show results
            setTimeout(() => {
                progressSection.classList.add('hidden');
                resultsSection.classList.remove('hidden');
                
                document.getElementById('booksImported').textContent = result.books_imported;
                document.getElementById('ratingsImported').textContent = result.ratings_imported;
                document.getElementById('skipped').textContent = result.skipped;

                if (result.errors && result.errors.length > 0) {
                    const errorsList = document.getElementById('errorsList');
                    errorsList.classList.remove('hidden');
                    errorsList.querySelector('ul').innerHTML = result.errors
                        .map(err => `<li>${err}</li>`)
                        .join('');
                }
            }, 500);

        } catch (error) {
            clearInterval(progressInterval);
            progressSection.classList.add('hidden');
            showError(error.message || 'Import failed. Please try again.');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Import Books';
        }
    });

    function showError(message) {
        errorMessage.textContent = message;
        errorMessage.classList.remove('hidden');
    }

    function updateProgress(percent) {
        progressBar.style.width = percent + '%';
        progressText.textContent = percent + '%';
    }
</script>
</body>
</html>